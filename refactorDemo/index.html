<html>
  <head>
    <title>Walter White Labs</title> 
  </head>
  <body>
    <div class="main">
      <h2>Saul's Relocation Possibilities</h2>
      <div id="list-of-countries"></div>
      <div id="details">
        <ul>
          <li><span>Currency Code: </span><span id="currency"></span></li>
          <li><span>Language Code: </span><span id="language"></span></li>
          <li><span>Distance from ABQ: </span><span id="distance"></span></li>
        </ul>
      </div>
    </div>
    <script type="text/javascript" src="../assets/javascript/underscore-min.js"></script>
    <script type="text/javascript" src="../assets/javascript/jquery-min.js"></script>
    <script type="text/javascript" src="../assets/javascript/backbone-min.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script type="text/javascript">
      var loadCountries, countries, countryDetails, distanceHaversine;

      distanceHaversine = (function() {
        rad = function(x) { return x*Math.PI/180; }

        distHaversine = function(p1, p2) {
          var R = 3959, // earth's mean radius in miles
              dLat  = rad(p2.lat - p1.lat),
              dLong = rad(p2.lng - p1.lng),

              a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(rad(p1.lat)) * Math.cos(rad(p2.lat)) * Math.sin(dLong/2) * Math.sin(dLong/2),
              c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)),
              d = R * c;

          return d.toFixed(0);
        }
        
        return {
          distance: distHaversine
        }
      })();
      

      loadCountries = function(data){
        countries = data;
        _.each(countries, function(country){
          html  = '<div class="property-card" data-id="' + country.alpha2Code + '">';
          html += '<span>' + country.name + '</span>';
          html += '<button class="country-details" data-id="' + country.alpha2Code + '">View Details</button>';
          html += '</div>';

          $('#list-of-countries').append(html);
        });
        
      };

      countryDetails = function(countryCode){
        $('#details').show();

        var selectedCountry = _.findWhere(countries, {alpha2Code: countryCode}),
            geoPoint = {lat: selectedCountry.latlng[0], lng: selectedCountry.latlng[1]},
            theAbq = {lat: 35.1107, lng: -106.6100};

        $('#currency').text(selectedCountry.currency);
        $('#language').text(selectedCountry.languages);
        $('#distance').text(distanceHaversine.distance(theAbq, geoPoint) + " miles");
      };

      $("#list-of-countries").on('click', 'button.country-details', function(){ countryDetails($(this).data('id')); });

      $(function(){
        $('#details').hide();
        $.get('http://restcountries.eu/rest/alpha?codes=mx;no;nz;tz;aw', loadCountries);
      });
    </script>
  </body>
</html>
